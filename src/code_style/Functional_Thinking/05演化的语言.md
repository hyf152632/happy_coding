# 演化的语言

函数式编程语言和面向对象语言对待代码重用的方式不一样。面向对象语言喜欢大量地建立有很多操作的各种数据结构，函数式语言也有很多的操作，但对应的数据结构却很少。
面向对象语言鼓励我们建立专门针对某个类的方法，我们从类的关系中发现重复出现的模式并加以重用。函数式语言的重用表现在函数的通用性上，它们鼓励在数据结构上使用各种共通的变换，并通过高阶函数来调整操作以满足具体事项的要求。

## 少量的数据结构搭配大量的操作

100 个函数操作一种数据结构的组合，要好过 10 个函数操作 10 种数据结构的组合。

## 让语言去迎合问题

重塑语言的能力算不上函数式语言独有的特性，现代引进普遍可以轻巧地揉捏语言来贴合问题域，不过在这种能力的影响下，更容易催生带有浓厚函数式，描述式风格的代码。

让程序去贴合问题，不要反过来。

## 对分发机制的再思考

我们用“分发机制”这个词来泛称各种语言中用作“动态地选择行为”的特性。与 Java 的做法相比，几种函数式
JVM 语言的分发机制更加简洁、灵活，我们就用这一节来讨论它们。

Java 代码要表述“条件执行”，除了很少的一些情况适用 switch 语句，大多离不开 if 语句。由于长串的 if 语句难以阅读，Java 开发者通常需要依赖 GoF 模式集里面的 Factory 模式（或者 Abstract Factory 模式）来缓解问题。如果语言直接提供更灵活的方式来表述复杂的判断，我们就不必负担随模式而来的额外的结构，于是代码就大大简化了。

加强的 switch 在连串 if 和 Factory 设计模式之间提供了一个有用的平衡点。Groovy 的 switch 允许匹配区间和其他复杂类型，可在编程中起到与 Scala 模式匹配类似的作用。

Java 以及很多类似的语言都包含“关键字”的概念，把它们当作语法上的支点。在这类
语言中，开发者不可以自创新的关键字（不过有的语言允许通过元编程来实现语言扩展），
关键字蕴含了开发者无法从其他地方获得的语义。例如 Java 的 f 语句懂得对布尔运算作
短路处理。我们可以在 Java 语言下创建函数和类，但没办法创造基本的语法构造单元，因
此必须把问题翻译成符合编程语言语法的陈述。（实际上很多开发者认为自己的工作就是
从事这种翻译活动。）而在 Clojure 等 Lisp 家族的语言下，开发者可以根据问题来修改语
言，并没有一条明确的界线隔开语言设计者和使用语言来进行创作的开发者。

Clojure 可以写出富于可读性的（Lisp 风格的）代码。例 5 一 5 用 Clojure 语言重新实现了前
面的成绩分等例子。

切断多态和继承之间的耦合关系，催生了一一种强大的、灵活周全的分发机制。这样的分发
机制能够处理相当复杂的情况，例如不同图像文件格式的分发问题，每种格式类型都是由
各不相同的一一组特征来定义的。多重方法赋予了 Clojure 构造强大分发机制的能力，其适
应性不输于 Java 的多态，而且限制更少。

## 运算符重载

运算符重载是函数式语言常见的特性，它允许我们重新定义运算符（诸如+、一、\*），使之适用于新的类型，并承载新的行为。

Java 语言的设计者从使用 C++语言的经验中得出结论，认为运算符重载会给语言增加过多的复杂性，因此刻意从 Java 语言里排除了这种特性。现代语言大多已经相当程度地消除了定义上的复杂性，但以往关于滥用运算符重载的告诫都还是成立的。

要想契合问题域的表达习惯，可以利用运算符重载来改变语言的外貌，不必创造全新的语言。

## 函数式的数据结构

“异常”违背了大多数函数式语言所遵循的一些前提条件。首先，函数式语言偏好没有副作用的纯函数。抛出异常的行为本身就是一一种副作用，会导致程序路径偏离正轨（进入异常的流程）。函数式语言以操作值为其根本，因此喜欢在返回值里表明错误并作出响应，这样就不需要打断程序的一一般流程了。

引用的透明性（referentialtransparency）是函数式语言重视的另一项性质：发出调用的例程不必关心它的访问对象真的是一一个值，还是一个返回值的函数。可是如果函数有可能抛出异常的话，用它来代替值就不再是安全的了。

Either 类

函数式语言也经常会遇到返回两种截然不同的值的需求，它们用来建模这种行为的常用数据结构是 Either 类。Either 的设计规定了它要么持有“左值”，要么持有“右值”，但绝不会同时持有两者。这种数据结构也被称为不相交联合体（disjointunion）。C 语言和一些衍生语言中有一种联合体（union） 数据类型，能够在同一个位置上容纳不同类型的单个实例。不相交联合体为两种类型的实例都准备了位置，但只会持有其中一一种类型的单个实例。

Option 类

Either 代表了一 一种使用方便、用途广泛的概念，除了用来实现双重返回值，还被用来构建一些通用的数据结构（如本章后面将讨论的基于 Either 的树结构）。在表示函数返回值这个用途上，有些语言和框架除了 Either 类之外，还存在另一一个选项一 Option. option 类表述了异常处理中较为简化的一种场景， 它的取值要么是 none，表示不存在有效值， 要么是 some，表示成功返回。
