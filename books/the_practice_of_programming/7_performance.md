# 性能

很久以前，程序员花费了他们的主要精力，想方设法把程序的效率弄得高一点。因为在 那个时候计算机非常慢，而且非常昂贵。今天的机器便宜多了也快多了，因此，对绝对效率 的需求也就大大地减弱了。我们难道还值得去考虑执行性能吗?
当然需要。但是，只有在问题确实是非常重要，程序真正是非常慢，而且确有预期能在 保持正确性、坚固性和清晰性的同时把程序弄得更快的情况下，才应该做这件事情。一个快 速的程序如果给出的是错误结果，那么它一点也没有节省时间。

优化的第一要义是不做。程序是不是已经足够好了?应该了解程序将如何使用以及它将要 运行于其中的环境，把它搞得更快有什么益处吗?

什么时候我们应该试图去加速一个程序?我们该如何做，又能够期望得到些什么呢?本 章要讨论如何能使程序运行得更快些，或者少用些存储。速度通常是人们最关心的，因此也 是我们讨论的主题。空间 (主存、磁盘 )出问题的情况少一点，但也可能是至关重要的，所以我 们也要在这里花一些时间和空间 (篇幅)。

最好的策略就是使用那些能适应工作需要的、最简单最清晰的 算法和数据结构。然后再度量其性能，看是否需要做什么改变;打开编译系统的选择项，生 成尽可能快的代码;考虑对程序本身做什么改变才能有最大作用;一次做一个改变并重新进 行评价。在这期间始终保留最简单的版本，用它作为测试版本的对照物。

这是性能真有问题的一个例子:程序对于完成指定工作而言太慢，而人则由于其工作拖 延感到非常不舒服。这种程序确实必须大大地加快运行速度。

在需要解决问题的时候，最重要的是给出正确的提问。

加速策略

在改造一个程序，设法把它弄得更快之前，首先应该确定它确实太慢。然后应该通过计 时工具和轮廓文件，弄清时间到底跑到哪里去了。在你知道发生了什么之后，有一些可以采 用的策略。我们列出几个，按照获益递减的顺序。

使用更好的算法或数据结构。 要使程序运行速度快，最重要的因素是算法与数据结构的选择，有效的算法和不那么有效的算法造成的差距是巨大的。

让编译程序做优化。有一种毫不费力的改变就可能产生明显的加速效果，那就是打开编译系 统的所有优化开关。现代编译程序已经做得非常好了，这实际上大大减小了程序员对程序做 各种小改进的必要性。

编译程序的优化通常可以在所有地方改进运行的时间性能，一般从几个百分点到两倍的 样子。

还有一个问题应该引起警惕，那就是编译优化做得越多越深入，把错误引进编译结果 (程 序)的可能性也就越大。

调整代码。只要数据有足够的规模，算法的正确选择就会显示它的作用。进一步说，算法方 面的改进是跨机器、跨系统和跨语言的。但是，如果已经选择了正确的算法，程序的速度仍 然是问题的话，下一步还能做的就是调整代码，整理循环和表达式的细节，设法使事情做得 更快些。

不要优化那些无关紧要的东西。

我们到底应该在加快程序速度方面花多少时间?最重要的标准就是看所做的改造能否带 来足够的效益。作为一个准则，在加快程序速度方面所花的时间不应该超过这种加速在程序 的整个生存期间中获得的时间。

收集公共表达式。如果一个代价昂贵的计算多次出现，那么就只在一个地方做它，并记录计 算 的 结 果 。

用低代价操作代替高代价的。术语降低强度指的是用低代价操作代替高代价操作的那些优化。 在过去，这个说法特别用来指用加法和移位操作取代乘法。今天再这样做，恐怕不会有太大 收获了。

高速缓存频繁使用的值。以缓冲方式保存的值无须重新计算。缓存的价值来自于局部性。程 序和人都有这种倾向，那就是重复使用最近访问过的值，或者是近旁的值，而对老的值和远 距离的值则用得比较少。计算机硬件领域里广泛使用了缓存技术，给计算机增加缓冲存储器 后，确实能大大地改进机器在速度方面的表现。对于软件，情况也是一样的。

空间效率

存储空间过去一直是最贵重的计算资源，而且总是短缺的，想从这种没有多少油水的地方 榨出许多东西来，就会形成特别坏的程序设计。声名狼藉的“两千年问题”是经常被人提起的 典型例子。当存储器真正稀缺的时候，甚至为存储 1 9 所
需要的那两个字节也被认为是太昂贵了。 无论缺少空间是否是其中真正的原因 (实际上，这种代码也直接反映了人们在日常生活中写日期 的习惯，其中的世纪总是被省略的 )，这件事总是说明了一个短视的优化所具有的内在危险性。
